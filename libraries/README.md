# Product Embedded Library Modules

This directory contains product-embedded library modules that make third-party libraries available throughout the IntelliJ platform.

## Creating a New Library Module

To create a new product-embedded module for a library (e.g., for a library named "example-lib"):

### 1. Create Module Structure

Create the following directory structure:
```
community/libraries/example-lib/
├── intellij.libraries.example.lib.iml
└── resources/
    └── intellij.libraries.example.lib.xml
```

### 2. Create Module Definition File (`.iml`)

File: `intellij.libraries.example.lib.iml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<module type="JAVA_MODULE" version="4">
  <component name="NewModuleRootManager" LANGUAGE_LEVEL="JDK_1_8" inherit-compiler-output="true">
    <exclude-output />
    <content url="file://$MODULE_DIR$">
      <sourceFolder url="file://$MODULE_DIR$/resources" type="java-resource" />
    </content>
    <orderEntry type="inheritedJdk" />
    <orderEntry type="sourceFolder" forTests="false" />
    <orderEntry type="library" exported="" name="ExampleLibrary" level="project" />
  </component>
</module>
```

**Key points:**
- The `name` attribute in `<orderEntry type="library">` must match the library name defined in `.idea/libraries/ExampleLibrary.xml`
- If the module depends on other embedded modules, add them as additional `<orderEntry type="module">` entries (see `junit4` example)

### 3. Create Plugin Descriptor

File: `resources/intellij.libraries.example.lib.xml`

```xml
<idea-plugin>
</idea-plugin>
```

**Note:** If your module depends on other library modules, add them:
```xml
<idea-plugin>
  <dependencies>
    <module name="intellij.libraries.hamcrest"/>
  </dependencies>
</idea-plugin>
```

### 4. Register in Essential Libraries (if needed)

If the library should be loaded as an essential embedded module, add it to:

File: `community/platform/platform-resources/src/META-INF/essential-libs.xml`

```xml
<module name="intellij.libraries.example.lib" loading="embedded"/>
```

Add the entry in alphabetical order.

### 5. Register in Project Modules

Add the module to both `modules.xml` files. **CRITICAL**: Entries must be sorted by the `filepath` attribute value, not by module name or directory name. The IDE will auto-sort on save, but you should place entries in the correct position initially.

#### Root project file: `.idea/modules.xml`
```xml
<module fileurl="file://$PROJECT_DIR$/community/libraries/example-lib/intellij.libraries.example.lib.iml"
        filepath="$PROJECT_DIR$/community/libraries/example-lib/intellij.libraries.example.lib.iml" />
```

#### Community project file: `community/.idea/modules.xml`
```xml
<module fileurl="file://$PROJECT_DIR$/libraries/example-lib/intellij.libraries.example.lib.iml"
        filepath="$PROJECT_DIR$/libraries/example-lib/intellij.libraries.example.lib.iml" />
```

**Important:**
- Root `modules.xml` uses full path with `community/` prefix
- Community `modules.xml` uses relative path without `community/` prefix
- **Sorting**: Entries are sorted by `filepath` attribute (standard string comparison)
  - Example: `libraries/hamcrest` < `libraries/hamcrest-more-matchers` < `libraries/hash4j`
  - Note: Hyphen `-` comes before slash `/` in sorting, so `hamcrest-more-matchers` comes before `hash4j`
- The IDE will auto-correct sorting on save, but tests will fail if order is incorrect

### 6. Register in LIBRARY_MODULE_NAMES

Add the module name to the `LIBRARY_MODULE_NAMES` set in alphabetical order:

File: `community/platform/build-scripts/src/org/jetbrains/intellij/build/impl/libraries/libraries.kt`

```kotlin
private val LIBRARY_MODULE_NAMES: Set<String> = setOf(
  // ... other modules ...
  "intellij.libraries.example.lib",
  // ... other modules ...
)
```

**Note:** Some modules like `intellij.libraries.microba` and `intellij.libraries.cglib` are exceptions and should not be included in this list.

### 7. Build File

**Do NOT create `BUILD.bazel` manually** - it will be auto-generated by the build system.

### 8. Verify Changes

After creating the module, run the following tests to ensure project structure consistency:

- **`IdeaUltimatePluginStructureTest`** - Verifies the plugin structure for IDEA Ultimate
- **`CommunityProjectConsistencyTest`** - Verifies community project consistency

## Examples

- **Simple library:** `hamcrest/` - single library dependency
- **Library with dependencies:** `junit4/` - depends on hamcrest module
- **Multiple libraries:** `grpc/` - exports multiple related libraries

## Naming Conventions

- **Directory name:** Use kebab-case (e.g., `example-lib`, `grpc-netty-shaded`)
- **Module name:** Use dot-separated format (e.g., `intellij.libraries.example.lib`, `intellij.libraries.grpc.netty.shaded`)
- **IML filename:** Should match the module name (e.g., `intellij.libraries.example.lib.iml`)
- **Plugin XML filename:** Should match the module name (e.g., `intellij.libraries.example.lib.xml`)

## Prerequisites

Before creating a library module, ensure:
1. The library is already defined in `.idea/libraries/` as a project library
2. The library artifacts are available in the Maven repository or bundled appropriately

## Migrating Existing Library References to Library Modules

When converting a project-level library to an embedded library module, you need to update all `.iml` files that reference the library.

### Automated Migration Script

A generic Node.js script is available to automate the migration of library references across the entire project:

**Location:** `community/libraries/replace-lib-with-module.js`

**Usage:**
```bash
# Dry run to preview changes for Guava
node community/libraries/replace-lib-with-module.js --old-lib=Guava --new-module=intellij.libraries.guava --dry-run

# Apply Guava replacement
node community/libraries/replace-lib-with-module.js --old-lib=Guava --new-module=intellij.libraries.guava

# Replace a different library
node community/libraries/replace-lib-with-module.js --old-lib=Jackson --new-module=intellij.libraries.jackson

# Add custom exclude directories
node community/libraries/replace-lib-with-module.js --old-lib=Guava --new-module=intellij.libraries.guava --exclude=custom-dir

# Show help
node community/libraries/replace-lib-with-module.js --help
```

**Script Features:**
- Parses `.idea/modules.xml` to find all IML files
- Supports multiple replacement patterns:
  - Regular scope: `<orderEntry type="library" name="Guava" ... />` → `<orderEntry type="module" module-name="intellij.libraries.guava" />`
  - TEST scope: `<orderEntry type="library" scope="TEST" name="Guava" ... />` → `<orderEntry type="module" ... scope="TEST" />`
  - TEST scope with exported attribute
  - PROVIDED scope: `<orderEntry type="library" scope="PROVIDED" name="Guava" ... />` → `<orderEntry type="module" ... scope="PROVIDED" />`
- Excludes specified directories (default: `fleet/`, `toolbox/`)
- Provides detailed statistics of files modified and replacements made
- Dry-run mode to preview changes without modifying files

**Example Output:**
```
Configuration:
  Old library: Guava
  New module: intellij.libraries.guava
  Excluded dirs: fleet, toolbox
  Dry run: false

Found 15000 module files in modules.xml

Processing IML files:
  ✓ platform/ssh/intellij.platform.ssh.iml (1 regular)
  ✓ community/android/testartifacts/intellij.android.testartifacts.iml (1 regular)
  ...

Summary:
Files scanned: 14500
Files modified: 450
Files skipped: 550
Replacements by type:
  Regular scope: 330
  TEST scope: 122
  TEST scope (exported): 1
  PROVIDED scope: 7
  Total: 460
```
