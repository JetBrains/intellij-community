<project name="build Python plugin jar" default="dist">
  <!--
  You can set idea.home property here
  <property name="idea.home" value="c:\Program Files\JetBrains\IntelliJ IDEA 6951"/>
  -->
  <!--<property file="build-plugin.properties"/>-->

  <property name="plugin.home" value="${basedir}/.."/>
  <property name="plugin.revision" value="${build.number}"/>

  <property name="idea.lib" value="${idea.home}/lib"/>
  <property name="idea.plugins" value="${idea.home}/plugins"/>

  <property name="build.number" value="snapshot"/>

  <dirname property="basedir" file="${ant.file}"/>
  <property name="output" value="${basedir}/../dist"/>

  <property name="zipdir" value="${output}/zip"/>
  <property name="plugindir" value="${zipdir}/python"/>
  <property name="zipname" value="python-${plugin.revision}.zip"/>

  <property name="src.dir" location="${plugin.home}/src"/>
  <property name="resources.dir" location="${plugin.home}/resources"/>
  <property name="plugin.resources.dir" location="${plugin.home}/pluginResources"/>
  <property name="test.src.dir" location="${plugin.home}/testSrc"/>
  <property name="artifacts.dir" location="${output}/artifacts"/>

  <property name="classes.dir" value="${basedir}/dist/classes"/>
  <property name="test.classes.dir" value="${basedir}/dist/test-classes"/>

  <path id="classpath.lib">
    <fileset dir="${idea.lib}">
      <include name="?*.jar"/>
    </fileset>
    <fileset dir="${idea.plugins}/yaml/lib">
      <include name="yaml.jar"/>
    </fileset>
  </path>

  <path id="sourcepath">
    <dirset dir="${plugin.home}">
      <include name="resources"/>
      <include name="src"/>
      <include name="pluginSrc"/>
      <include name="pydevSrc"/>
    </dirset>
    <dirset dir="${plugin.home}/../ultimate/ultimate-verifier">
      <include name="src"/>
    </dirset>
  </path>

  <!-- The task requires the following libraries from IntelliJ IDEA distribution: -->
  <!--   javac2.jar; jdom.jar; asm.jar; asm-commons.jar -->
  <taskdef name="javac2" classname="com.intellij.ant.Javac2">
    <classpath refid="classpath.lib"/>
  </taskdef>

  <!-- Compiler options -->
  <property name="compiler.debug" value="on"/>
  <property name="compiler.generate.no.warnings" value="off"/>
  <property name="compiler.args" value=""/>
  <property name="compiler.max.memory" value="256m"/>

  <patternset id="sources.pt">
    <exclude name="**/.svn/**"/>
  </patternset>
  <patternset id="resources.pt">
    <include name="**/?*.properties"/>
    <include name="**/?*.template"/>
    <include name="**/?*.xml"/>
    <include name="**/?*.gif"/>
    <include name="**/?*.png"/>
    <include name="**/?*.txt"/>
    <include name="**/?*.jpeg"/>
    <include name="**/?*.jpg"/>
    <include name="**/?*.html"/>
    <include name="**/?*.dtd"/>
    <include name="**/?*.tld"/>
    <include name="**/?*.py"/>
    <include name="**/?*.ft"/>
  </patternset>


  <target name="clean" description="Cleanup output">
    <delete dir="${output}"/>
  </target>

  <target name="compile" description="Compile module python">
    <loadfile srcfile="${idea.home}/build.txt" property="idea.build.number">
      <filterchain>
        <deletecharacters chars="IU-"/>
      </filterchain>
    </loadfile>

    <mkdir dir="${classes.dir}"/>
    <!-- compile -->
    <javac2 destdir="${classes.dir}"
            debug="${compiler.debug}"
            nowarn="${compiler.generate.no.warnings}"
            memorymaximumsize="${compiler.max.memory}"
            fork="true">
      <compilerarg line="${compiler.args}"/>
      <classpath refid="classpath.lib"/>
      <src refid="sourcepath"/>
      <patternset refid="sources.pt"/>
    </javac2>

    <!-- copy resources -->
    <copy todir="${classes.dir}">
      <fileset dir="${resources.dir}">
        <patternset refid="resources.pt"/>
        <type type="file"/>
      </fileset>
      <fileset dir="${plugin.resources.dir}">
        <patternset refid="resources.pt"/>
        <type type="file"/>
      </fileset>
      <fileset dir="${plugin.home}/src">
        <patternset refid="resources.pt"/>
        <type type="file"/>
      </fileset>
      <fileset dir="${plugin.home}/../community/colorSchemes/src"/>
    </copy>

    <!-- copy plugin.xml -->
    <mkdir dir="${classes.dir}/META-INF"/>
    <copy todir="${classes.dir}/META-INF">
      <fileset dir="${plugin.home}/pluginSrc/META-INF"/>
    </copy>

    <replaceregexp file="${classes.dir}/META-INF/plugin.xml"
                   match="since-build=&quot;\d+\.\d+&quot;"
                   replace="since-build=&quot;${idea.build.number}&quot;"/>
  </target>

  <target name="jar" description="Generate jar file" depends="compile">
    <mkdir dir="${output}"/>
    <jar destfile="${output}/python.jar" basedir="${classes.dir}">
      <manifest>
        <attribute name="Revision" value="${plugin.revision}"/>
        <!--<attribute name="Build" value="${plugin.version}"/>-->
      </manifest>
    </jar>
  </target>

  <target name="zip" description="Generate zip plugin file" depends="jar">
    <mkdir dir="${zipdir}"/>

    <!--copy plugin jar-->
    <mkdir dir="${plugindir}/lib"/>
    <move todir="${plugindir}/lib" file="${output}/python.jar"/>

    <mkdir dir="${plugindir}/helpers"/>
    <copy todir="${plugindir}/helpers">
      <fileset dir="${plugin.home}/helpers">
        <include name="**/*.py"/>
        <include name="**/*.xml"/>
      </fileset>
    </copy>

    <zip basedir="${zipdir}" destfile="${output}/${zipname}"/>
  </target>

  <target name="build" depends="clean, compile"/>

  <target name="dist" depends="build, zip" description="main target"/>

  <target name="artifacts" depends="dist">
    <mkdir dir="${artifacts.dir}"/>
    <move file="${output}/${zipname}" todir="${artifacts.dir}"/>
  </target>

  <target name="build.artifacts" depends="dist, artifacts"/>

</project>