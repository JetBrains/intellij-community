// Copyright 2000-2020 JetBrains s.r.o. Use of this source code is governed by the Apache 2.0 license that can be found in the LICENSE file.
(function() {
  function checkAllLoaded(blocks) {
    return new Promise(resolve => {
      if (blocks.length === 0) {
        resolve();
        return;
      }
      const interval = setInterval(() => {
        if (blocks.every(block => block.querySelector("svg") != null)) {
          clearInterval(interval);
          resolve();
        }
      }, 20);
    });
  }

  window.addEventListener("load", () => {
    console.time("my-timer");
    console.log("Calling mermaid init");
    const blocks = Array.from(document.querySelectorAll("div.mermaid"));
    console.log(`${blocks.length} blocks will be generated by mermaid`);
    mermaid.init(null, "div.mermaid");
    checkAllLoaded(blocks).then(() => {
      console.log("Done with mermaid init");
      blocks.forEach(block => {
        let cacheId = block.getAttribute("cache-id");
        window.messagePipe.post("storeMermaidFile", `${cacheId};${block.innerHTML}`);
      });
      console.timeEnd("my-timer");
    });
  });
})();
